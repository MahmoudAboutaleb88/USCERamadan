<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø·Ø¨Ø§Ø¹Ø© Orders</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Cairo', sans-serif;
    padding: 20px;
    background: #fff;
    color: #000;
  }

  /* ===== Header ===== */
  .page-header {
    text-align: center;
    margin-bottom: 30px;
    border-bottom: 3px solid #000;
    padding-bottom: 12px;
  }
  .page-header h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .page-header .date-line {
    font-size: 13px;
    margin-top: 4px;
    color: #444;
  }

  /* ===== Loading / Error ===== */
  #loadingMsg {
    text-align: center;
    font-size: 16px;
    color: #555;
    padding: 40px;
  }

  /* ===== Department Block ===== */
  .department-block {
    margin-bottom: 36px;
  }

  /* ===== Department Table wrapper ===== */
  /*
    Ø§Ù„Ø­ÙŠÙ„Ø©: Ù†Ø­Ø· Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© + Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø®Ù„ <thead>
    Ø¹Ø´Ø§Ù† ÙŠØªÙƒØ±Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ ÙƒÙ„ ÙˆØ±Ù‚Ø© Ù„Ùˆ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø·ÙˆÙŠÙ„
  */
  table {
    width: 100%;
    border-collapse: collapse;
    border: 2px solid #1a1a2e;
  }

  /* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø§Ø®Ù„ thead */
  thead .dept-header-row td {
    background: #1a1a2e;
    color: #fff;
    padding: 7px 14px;
    font-size: 15px;
    font-weight: 700;
    text-align: right;
  }
  thead .dept-header-row td .count {
    background: #fff;
    color: #1a1a2e;
    border-radius: 50px;
    padding: 1px 10px;
    font-size: 13px;
    font-weight: 700;
    margin-right: 8px;
    display: inline-block;
  }

  /* Ù‡ÙŠØ¯Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  thead .cols-header-row th {
    background: #e8e8f0;
    border: 1px solid #999;
    padding: 8px 10px;
    text-align: center;
    font-size: 13px;
    font-weight: 700;
  }

  td {
    border: 1px solid #bbb;
    padding: 7px 10px;
    text-align: center;
    font-size: 13px;
  }
  tbody tr:nth-child(even) {
    background: #f9f9fc;
  }

  td.write-cell  { min-width: 130px; }
  td.checkbox-cell { width: 50px; }
  td.num-cell {
    width: 40px;
    font-weight: 600;
    color: #555;
  }

  /* ===== Footer ===== */
  .page-footer {
    text-align: center;
    font-size: 11px;
    color: #888;
    margin-top: 30px;
    border-top: 1px solid #ddd;
    padding-top: 10px;
  }

  /* ===== Buttons & Toolbar ===== */
  .toolbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    gap: 16px;
    flex-wrap: wrap;
  }

  .left-group,
  .right-group {
    display:flex;
    align-items:center;
    gap:12px;
  }

  .print-btn {
    padding: 10px 32px;
    background: #1a1a2e;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-family: 'Cairo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }
  .print-btn:hover { background: #2d2d50; }

  .logout-btn {
    padding: 10px 24px;
    background: #fff;
    color: #c0392b;
    border: 2px solid #c0392b;
    border-radius: 6px;
    font-family: 'Cairo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }
  .logout-btn:hover { background: #c0392b; color: #fff; }

  /* === NEW: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø´Ø®Ø§Øµ === */
  .total-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #eef6ff;
    color: #0b5cab;
    border: 1px solid #b8d6ff;
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 14px;
    line-height: 1;
    white-space: nowrap;
  }
  .total-badge .dot {
    width: 8px;
    height: 8px;
    background: #0b5cab;
    border-radius: 50%;
    display: inline-block;
    margin-left: 4px;
  }

  /* ===== Print Styles ===== */
  @media print {
    body { padding: 0; margin: 0; }

    .no-print { display: none !important; }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ÙŠØ¸Ù‡Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙˆÙ‚ ÙƒÙ„ ØµÙØ­Ø© */
    .page-header {
      position: running(mainHeader);
    }
    @page {
      margin: 30mm 12mm 12mm 12mm;
      @top-center {
        content: element(mainHeader);
      }
    }

    /* ÙƒÙ„ Ø¥Ø¯Ø§Ø±Ø© ØªØ¨Ø¯Ø£ ÙÙŠ ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© */
    .department-block {
      page-break-before: always;
    }
    .department-block:first-of-type {
      page-break-before: avoid;
    }

    /*
      thead ÙŠØªÙƒØ±Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ ÙƒÙ„ ÙˆØ±Ù‚Ø© Ù…Ù† ÙˆØ±Ù‚ Ù†ÙØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      ÙØ¨Ù…Ø§ Ø¥Ù† Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© + Ù‡ÙŠØ¯Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙƒÙ„Ù‡Ù… ÙÙŠ thead
      Ù‡ÙŠØªÙƒØ±Ø±ÙˆØ§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    */
    thead {
      display: table-header-group;
    }

    tr { page-break-inside: avoid; }

    thead .dept-header-row td {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    thead .cols-header-row th {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    tbody tr:nth-child(even) {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .page-footer { display: none; }
  }
</style>
</head>
<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="page-header">
  <h1>Ramadan Meals Ordering System</h1>
  <div class="date-line" id="todayLabel"></div>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· -->
<div class="no-print toolbar">
  <div class="right-group">
    <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>

    <!-- === NEW: Ù„ÙŠØ¨ÙÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø´Ø®Ø§Øµ === -->
    <div class="total-badge" id="totalCount" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª">
      <span class="dot" aria-hidden="true"></span>
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</span>
    </div>
  </div>

  <div class="left-group">
    <button class="logout-btn" onclick="window.location.href='index.html'">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<div id="loadingMsg">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
<div id="tablesContainer"></div>

<div class="page-footer" id="pageFooter" style="display:none">
  ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ - Mahmoud Abou taleb â€” <span id="footerDate"></span>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwztJdA4AcbAlXIggDE_eEZVPOhiF0H6kIZ3WnVLsYatrXWSa0bHOrXK_1fnrKH131jmg/exec";

  function getTodayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function formatArabicDate(str) {
    const d = new Date(str);
    return d.toLocaleDateString('ar-EG', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
  }

  const todayStr = getTodayStr();
  document.getElementById('todayLabel').textContent = formatArabicDate(todayStr);
  document.getElementById('footerDate').textContent = todayStr;

  async function fetchOrders() {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=get_orders`
      });
      const data = await res.json();

      if (!data.ok) throw new Error(data.error || "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

      // ØªØµÙÙŠØ© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·
      const todayOrders = data.orders.filter(o => o.date === todayStr);

      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      document.getElementById('loadingMsg').style.display = 'none';

      // === NEW: ØªØ­Ø¯ÙŠØ« Ù„ÙŠØ¨ÙÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ===
      const totalLabel = document.getElementById('totalCount');
      totalLabel.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${todayOrders.length}`;

      if (todayOrders.length === 0) {
        document.getElementById('tablesContainer').innerHTML =
          "<p style='text-align:center;color:#888;padding:40px;font-size:15px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p>";
        // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù†Ø®Ù„ÙŠ Ø§Ù„Ù„ÙŠØ¨ÙÙ„ ÙŠØ¸Ù‡Ø± ØµÙØ± (Ø§ØªØ¹Ù…Ù„ ÙÙˆÙ‚)
        document.getElementById('pageFooter').style.display = 'block';
        return;
      }

      renderTables(todayOrders);
      document.getElementById('pageFooter').style.display = 'block';

    } catch (err) {
      document.getElementById('loadingMsg').innerHTML =
        `<p style="color:red;">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${err.message}</p>`;
    }
  }

  function renderTables(orders) {
    const container = document.getElementById('tablesContainer');

    // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    const departments = {};
    orders.forEach(o => {
      const dept = o.department || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      if (!departments[dept]) departments[dept] = [];
      departments[dept].push(o);
    });

    // ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ
    const sortedDepts = Object.keys(departments).sort((a, b) => a.localeCompare(b, 'ar'));

    sortedDepts.forEach(dept => {
      const list = departments[dept];
      const block = document.createElement('div');
      block.className = 'department-block';

      /*
        Ø§Ù„Ø­ÙŠÙ„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
        - Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ thead (ØµÙ Ø£ÙˆÙ„)
        - Ù‡ÙŠØ¯Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ thead (ØµÙ ØªØ§Ù†ÙŠ)
        => Ù„Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠÙ…ØªØ¯ Ù„ÙˆØ±Ù‚ØªÙŠÙ† Ø£Ùˆ Ø£ÙƒØªØ±ØŒ Ø§Ù„Ø§ØªÙ†ÙŠÙ† Ù‡ÙŠØªÙƒØ±Ø±ÙˆØ§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      */
      block.innerHTML = `
        <table>
          <thead>
            <tr class="dept-header-row">
              <td colspan="5">
                Ø¥Ø¯Ø§Ø±Ø©: ${dept}
                <span class="count">${list.length}</span>
              </td>
            </tr>
            <tr class="cols-header-row">
              <th class="num-cell">#</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
              <th class="checkbox-cell">âœ“</th>
              <th class="write-cell">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            ${list.map((o, i) => `
              <tr>
                <td class="num-cell">${i + 1}</td>
                <td>${o.employee}</td>
                <td>${dept}</td>
                <td class="checkbox-cell"></td>
                <td class="write-cell"></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.appendChild(block);
    });
  }

  fetchOrders();
</script>
</body>
</html>
