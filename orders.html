<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø·Ø¨Ø§Ø¹Ø© Orders</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Cairo', sans-serif;
    padding: 20px;
    background: #fff;
    color: #000;
  }

  /* ===== Header ===== */
  .page-header {
    text-align: center;
    margin-bottom: 30px;
    border-bottom: 3px solid #000;
    padding-bottom: 12px;
  }
  .page-header h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .page-header .date-line {
    font-size: 13px;
    margin-top: 4px;
    color: #444;
  }

  /* ===== Loading / Error ===== */
  #loadingMsg {
    text-align: center;
    font-size: 16px;
    color: #555;
    padding: 40px;
  }

  /* ===== Department Block ===== */
  .department-block {
    margin-bottom: 36px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    border: 2px solid #1a1a2e;
  }

  thead .dept-header-row td {
    background: #1a1a2e;
    color: #fff;
    padding: 7px 14px;
    font-size: 15px;
    font-weight: 700;
    text-align: right;
  }
  thead .dept-header-row td .count {
    background: #fff;
    color: #1a1a2e;
    border-radius: 50px;
    padding: 1px 10px;
    font-size: 13px;
    font-weight: 700;
    margin-right: 8px;
    display: inline-block;
  }

  thead .cols-header-row th {
    background: #e8e8f0;
    border: 1px solid #999;
    padding: 8px 10px;
    text-align: center;
    font-size: 13px;
    font-weight: 700;
  }

  td {
    border: 1px solid #bbb;
    padding: 7px 10px;
    text-align: center;
    font-size: 13px;
  }
  tbody tr:nth-child(even) {
    background: #f9f9fc;
  }

  td.write-cell  { min-width: 130px; }
  td.checkbox-cell { width: 50px; }
  td.num-cell {
    width: 40px;
    font-weight: 600;
    color: #555;
  }

  /* ===== Footer ===== */
  .page-footer {
    text-align: center;
    font-size: 11px;
    color: #888;
    margin-top: 30px;
    border-top: 1px solid #ddd;
    padding-top: 10px;
  }

  /* ===== Buttons & Toolbar ===== */
  .toolbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    gap: 16px;
    flex-wrap: wrap;
  }

  .left-group,
  .right-group {
    display:flex;
    align-items:center;
    gap:12px;
  }

  .print-btn {
    padding: 10px 32px;
    background: #1a1a2e;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-family: 'Cairo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }
  .print-btn:hover { background: #2d2d50; }

  .logout-btn {
    padding: 10px 24px;
    background: #fff;
    color: #c0392b;
    border: 2px solid #c0392b;
    border-radius: 6px;
    font-family: 'Cairo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }
  .logout-btn:hover { background: #c0392b; color: #fff; }

  /* === NEW: Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª === */
  .danger-btn {
    padding: 10px 24px;
    background: #fff;
    color: #b00020;
    border: 2px solid #b00020;
    border-radius: 6px;
    font-family: 'Cairo', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
  }
  .danger-btn:hover { background: #b00020; color: #fff; }
  .danger-btn:disabled { opacity: .6; cursor: not-allowed; }

  /* === NEW: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø´Ø®Ø§Øµ === */
  .total-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #eef6ff;
    color: #0b5cab;
    border: 1px solid #b8d6ff;
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 14px;
    line-height: 1;
    white-space: nowrap;
  }
  .total-badge .dot {
    width: 8px;
    height: 8px;
    background: #0b5cab;
    border-radius: 50%;
    display: inline-block;
    margin-left: 4px;
  }

  /* ===== Toast (Ø±Ø³Ø§Ø¦Ù„) ===== */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: #1a1a2e;
    color: #fff;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    transition: transform .3s ease;
    white-space: nowrap;
    z-index: 9999;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { background: #2e7d32; }
  .toast.error { background: #c62828; }
  .toast.warn  { background: #f39c12; color: #000; }

  /* ===== Print Styles ===== */
  @media print {
    body { padding: 0; margin: 0; }
    .no-print { display: none !important; }

    .page-header { position: running(mainHeader); }
    @page {
      margin: 30mm 12mm 12mm 12mm;
      @top-center { content: element(mainHeader); }
    }

    .department-block { page-break-before: always; }
    .department-block:first-of-type { page-break-before: avoid; }

    thead { display: table-header-group; }
    tr { page-break-inside: avoid; }

    thead .dept-header-row td,
    thead .cols-header-row th,
    tbody tr:nth-child(even) {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .page-footer { display: none; }
  }
</style>
</head>
<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="page-header">
  <h1>Ramadan Meals Ordering System</h1>
  <div class="date-line" id="todayLabel"></div>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· -->
<div class="no-print toolbar">
  <div class="right-group">
    <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>

    <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø´Ø®Ø§Øµ -->
    <div class="total-badge" id="totalCount" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª">
      <span class="dot" aria-hidden="true"></span>
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</span>
    </div>
  </div>

  <div class="left-group">
    <!-- NEW: Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <button id="deleteBtn" class="danger-btn" onclick="confirmDeleteAll()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <button class="logout-btn" onclick="window.location.href='index.html'">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<div id="loadingMsg">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
<div id="tablesContainer"></div>

<div class="page-footer" id="pageFooter" style="display:none">
  ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ - Mahmoud Abou taleb â€” <span id="footerDate"></span>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxFhhA5mG-jPSexRF0hQk-qJ6vB4JuzPcDxy1UQDHv6MP4asgYGWt2FMahmpWEm2JCPsg/exec";

  function showToast(msg, type = '') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  function getTodayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function formatArabicDate(str) {
    const d = new Date(str);
    return d.toLocaleDateString('ar-EG', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
  }

  const todayStr = getTodayStr();
  document.getElementById('todayLabel').textContent = formatArabicDate(todayStr);
  document.getElementById('footerDate').textContent = todayStr;

  async function fetchOrders() {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=get_orders`
      });
      const data = await res.json();

      if (!data.ok) throw new Error(data.error || "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

      const todayOrders = data.orders.filter(o => o.date === todayStr);

      document.getElementById('loadingMsg').style.display = 'none';

      // ØªØ­Ø¯ÙŠØ« Ù„ÙŠØ¨ÙÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
      const totalLabel = document.getElementById('totalCount').querySelector('span:last-child');
      totalLabel.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${todayOrders.length}`;

      if (todayOrders.length === 0) {
        document.getElementById('tablesContainer').innerHTML =
          "<p style='text-align:center;color:#888;padding:40px;font-size:15px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p>";
        document.getElementById('pageFooter').style.display = 'block';
        return;
      }

      renderTables(todayOrders);
      document.getElementById('pageFooter').style.display = 'block';

    } catch (err) {
      document.getElementById('loadingMsg').innerHTML =
        `<p style="color:red;">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${err.message}</p>`;
    }
  }

  function renderTables(orders) {
    const container = document.getElementById('tablesContainer');

    const departments = {};
    orders.forEach(o => {
      const dept = o.department || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      if (!departments[dept]) departments[dept] = [];
      departments[dept].push(o);
    });

    const sortedDepts = Object.keys(departments).sort((a, b) => a.localeCompare(b, 'ar'));

    sortedDepts.forEach(dept => {
      const list = departments[dept];
      const block = document.createElement('div');
      block.className = 'department-block';

      block.innerHTML = `
        <table>
          <thead>
            <tr class="dept-header-row">
              <td colspan="5">
                Ø¥Ø¯Ø§Ø±Ø©: ${dept}
                <span class="count">${list.length}</span>
              </td>
            </tr>
            <tr class="cols-header-row">
              <th class="num-cell">#</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
              <th class="checkbox-cell">âœ“</th>
              <th class="write-cell">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            ${list.map((o, i) => `
              <tr>
                <td class="num-cell">${i + 1}</td>
                <td>${o.employee}</td>
                <td>${dept}</td>
                <td class="checkbox-cell"></td>
                <td class="write-cell"></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.appendChild(block);
    });
  }

  // ===== NEW: Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª =====
  async function confirmDeleteAll() {
    const btn = document.getElementById('deleteBtn');

    // ØªØ£ÙƒÙŠØ¯ Ø£ÙˆÙ„
    const ok = confirm("âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Orders) Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
    if (!ok) return;

    // ØªØ£ÙƒÙŠØ¯ Ø«Ø§Ù†ÙŠ Ø¨ÙƒØªØ§Ø¨Ø© DELETE
    const text = prompt("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© DELETE Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:");
    if ((text || '').trim().toUpperCase() !== 'DELETE') {
      showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.', 'warn');
      return;
    }

    try {
      btn.disabled = true;
      btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=delete_all_orders`
      });
      const data = await res.json();

      if (!data.ok) {
        throw new Error(data.message || data.error || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      document.getElementById('tablesContainer').innerHTML = '';
      document.getElementById('loadingMsg').style.display = 'none';

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
      const totalLabel = document.getElementById('totalCount').querySelector('span:last-child');
      totalLabel.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0`;

      showToast(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ (Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: ${data.cleared || 0})`, 'success');

    } catch (err) {
      showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + err.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }
  }

  fetchOrders();
</script>
</body>
</html>
