<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø·Ø¨Ø§Ø¹Ø© Orders</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Cairo', sans-serif;
    padding: 20px;
    background: #fff;
    color: #000;
  }

  /* ===== Header ===== */
  .page-header {
    text-align: center;
    margin-bottom: 30px;
    border-bottom: 3px solid #000;
    padding-bottom: 12px;
  }
  .page-header h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .page-header .date-line {
    font-size: 13px;
    margin-top: 4px;
    color: #444;
  }

  /* ===== Loading / Error ===== */
  #loadingMsg {
    text-align: center;
    font-size: 16px;
    color: #555;
    padding: 40px;
  }

  /* ===== Department Block ===== */
  .department-block {
    margin-bottom: 36px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    border: 2px solid #1a1a2e;
  }

  thead .dept-header-row td {
    background: #1a1a2e;
    color: #fff;
    padding: 7px 14px;
    font-size: 15px;
    font-weight: 700;
    text-align: right;
  }
  thead .dept-header-row td .count {
    background: #fff;
    color: #1a1a2e;
    border-radius: 50px;
    padding: 1px 10px;
    font-size: 13px;
    font-weight: 700;
    margin-right: 8px;
    display: inline-block;
  }

  thead .cols-header-row th {
    background: #e8e8f0;
    border: 1px solid #999;
    padding: 8px 10px;
    text-align: center;
    font-size: 13px;
    font-weight: 700;
  }

  td {
    border: 1px solid #bbb;
    padding: 7px 10px;
    text-align: center;
    font-size: 13px;
  }
  tbody tr:nth-child(even) {
    background: #f9f9fc;
  }

  td.write-cell  { min-width: 130px; }
  td.checkbox-cell { width: 50px; }
  td.num-cell {
    width: 40px;
    font-weight: 600;
    color: #555;
  }

  /* ===== Footer ===== */
  .page-footer {
    text-align: center;
    font-size: 11px;
    color: #888;
    margin-top: 30px;
    border-top: 1px solid #ddd;
    padding-top: 10px;
  }

  /* ===== Buttons & Toolbar ===== */
  .toolbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    gap: 16px;
    flex-wrap: wrap;
  }

  .left-group,
  .right-group {
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap: wrap;
  }

  .print-btn {
    padding: 10px 32px;
    background: #1a1a2e;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-family: 'Cairo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }
  .print-btn:hover { background: #2d2d50; }

  .logout-btn {
    padding: 10px 24px;
    background: #fff;
    color: #c0392b;
    border: 2px solid #c0392b;
    border-radius: 6px;
    font-family: 'Cairo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }
  .logout-btn:hover { background: #c0392b; color: #fff; }

  .danger-btn {
    padding: 10px 24px;
    background: #fff;
    color: #b00020;
    border: 2px solid #b00020;
    border-radius: 6px;
    font-family: 'Cairo', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
  }
  .danger-btn:hover { background: #b00020; color: #fff; }
  .danger-btn:disabled { opacity: .6; cursor: not-allowed; }

  /* ===== Stats Badges ===== */
  .stats-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .stat-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 13px;
    line-height: 1;
    white-space: nowrap;
  }

  /* Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø£Ø²Ø±Ù‚ */
  .stat-badge.employees {
    background: #eef6ff;
    color: #0b5cab;
    border: 1px solid #b8d6ff;
  }
  .stat-badge.employees .dot { background: #0b5cab; }

  /* Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ - Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
  .stat-badge.contractor {
    background: #fff7ed;
    color: #b45309;
    border: 1px solid #fcd69a;
  }
  .stat-badge.contractor .dot { background: #b45309; }

  /* Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª - Ø£Ø®Ø¶Ø± */
  .stat-badge.total-meals {
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #86efac;
    font-size: 14px;
    padding: 9px 14px;
  }
  .stat-badge.total-meals .dot { background: #166534; }

  .stat-badge .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }

  .divider-badge {
    color: #ccc;
    font-size: 20px;
    font-weight: 300;
    line-height: 1;
  }

  /* ===== Toast ===== */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: #1a1a2e;
    color: #fff;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    transition: transform .3s ease;
    white-space: nowrap;
    z-index: 9999;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { background: #2e7d32; }
  .toast.error { background: #c62828; }
  .toast.warn  { background: #f39c12; color: #000; }

  /* ===== Print Styles ===== */
  @media print {
    body { padding: 0; margin: 0; }
    .no-print { display: none !important; }

    .page-header { position: running(mainHeader); }
    @page {
      margin: 30mm 12mm 12mm 12mm;
      @top-center { content: element(mainHeader); }
    }

    .department-block { page-break-before: always; }
    .department-block:first-of-type { page-break-before: avoid; }

    thead { display: table-header-group; }
    tr { page-break-inside: avoid; }

    thead .dept-header-row td,
    thead .cols-header-row th,
    tbody tr:nth-child(even) {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .page-footer { display: none; }
  }
</style>
</head>
<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="page-header">
  <h1>Ramadan Meals Ordering System</h1>
  <div class="date-line" id="todayLabel"></div>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· -->
<div class="no-print toolbar">
  <div class="right-group">
    <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="stats-row">
      <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
      <div class="stat-badge employees" id="empBadge" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙŠÙˆÙ…">
        <span class="dot"></span>
        <span>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†: <strong id="empCount">â€”</strong></span>
      </div>

      <span class="divider-badge">+</span>

      <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ -->
      <div class="stat-badge contractor" id="conBadge" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…">
        <span class="dot"></span>
        <span>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„: <strong id="conCount">â€”</strong></span>
      </div>

      <span class="divider-badge">=</span>

      <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª -->
      <div class="stat-badge total-meals" id="totalBadge" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©">
        <span class="dot"></span>
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª: <strong id="totalCount">â€”</strong></span>
      </div>
    </div>
  </div>

  <div class="left-group">
    <button id="deleteBtn" class="danger-btn" onclick="confirmDeleteAll()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <button class="logout-btn" onclick="window.location.href='index.html'">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<div id="loadingMsg">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
<div id="tablesContainer"></div>

<div class="page-footer" id="pageFooter" style="display:none">
  ØªÙ… Ø¥ØµØ¯Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØªØ§Ø±ÙŠØ® - Mahmoud Abou taleb â€” <span id="footerDate"></span>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  const ORDERS_API   = "https://script.google.com/macros/s/AKfycbxFhhA5mG-jPSexRF0hQk-qJ6vB4JuzPcDxy1UQDHv6MP4asgYGWt2FMahmpWEm2JCPsg/exec";
  const CONTRACTOR_API = "https://script.google.com/macros/s/AKfycbw7yJo25YWoIpzO5fw_WlOxzF6qytA8AxqIfgfXC_o6MsGwMLGbORkQa0zQ93rNJsNs6Q/exec";

  let empTotal = 0;
  let conTotal = 0;

  function showToast(msg, type = '') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 3500);
  }

  function getTodayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function formatArabicDate(str) {
    const d = new Date(str);
    return d.toLocaleDateString('ar-EG', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
  }

  const todayStr = getTodayStr();
  document.getElementById('todayLabel').textContent = formatArabicDate(todayStr);
  document.getElementById('footerDate').textContent = todayStr;

  function updateTotalsUI() {
    document.getElementById('empCount').textContent   = empTotal;
    document.getElementById('conCount').textContent   = conTotal === null ? 'â€”' : conTotal;
    const grand = empTotal + (conTotal || 0);
    document.getElementById('totalCount').textContent = grand;
  }

  /* ===== Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ===== */
  async function fetchOrders() {
    try {
      const res = await fetch(ORDERS_API, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=get_orders`
      });
      const data = await res.json();

      if (!data.ok) throw new Error(data.error || "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

      const todayOrders = data.orders.filter(o => o.date === todayStr);

      document.getElementById('loadingMsg').style.display = 'none';

      empTotal = todayOrders.length;
      updateTotalsUI();

      if (todayOrders.length === 0) {
        document.getElementById('tablesContainer').innerHTML =
          "<p style='text-align:center;color:#888;padding:40px;font-size:15px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p>";
      } else {
        renderTables(todayOrders);
      }

      document.getElementById('pageFooter').style.display = 'block';

    } catch (err) {
      document.getElementById('loadingMsg').innerHTML =
        `<p style="color:red;">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${err.message}</p>`;
    }
  }

  /* ===== Ø¬Ù„Ø¨ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ===== */
  async function fetchContractor() {
    try {
      const res = await fetch(CONTRACTOR_API, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=get_contractor&date=${todayStr}`
      });
      const data = await res.json();

      if (!data.ok) throw new Error(data.error || "Ø®Ø·Ø£");

      conTotal = data.quantity !== null ? Number(data.quantity) : 0;
      updateTotalsUI();

    } catch (err) {
      conTotal = 0;
      document.getElementById('conCount').textContent = 'Ø®Ø·Ø£';
      console.warn('Contractor fetch error:', err.message);
    }
  }

  function renderTables(orders) {
    const container = document.getElementById('tablesContainer');

    const departments = {};
    orders.forEach(o => {
      const dept = o.department || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      if (!departments[dept]) departments[dept] = [];
      departments[dept].push(o);
    });

    const sortedDepts = Object.keys(departments).sort((a, b) => a.localeCompare(b, 'ar'));

    sortedDepts.forEach(dept => {
      const list = departments[dept];
      const block = document.createElement('div');
      block.className = 'department-block';

      block.innerHTML = `
        <table>
          <thead>
            <tr class="dept-header-row">
              <td colspan="5">
                Ø¥Ø¯Ø§Ø±Ø©: ${dept}
                <span class="count">${list.length}</span>
              </td>
            </tr>
            <tr class="cols-header-row">
              <th class="num-cell">#</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
              <th class="checkbox-cell">âœ“</th>
              <th class="write-cell">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            ${list.map((o, i) => `
              <tr>
                <td class="num-cell">${i + 1}</td>
                <td>${o.employee}</td>
                <td>${dept}</td>
                <td class="checkbox-cell"></td>
                <td class="write-cell"></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.appendChild(block);
    });
  }

  /* ===== Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…ÙˆØ¸ÙÙŠÙ† + Ù…Ù‚Ø§ÙˆÙ„) ===== */
  async function confirmDeleteAll() {
    const btn = document.getElementById('deleteBtn');

    const ok = confirm("âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ„) Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
    if (!ok) return;

    const text = prompt("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© DELETE Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:");
    if ((text || '').trim().toUpperCase() !== 'DELETE') {
      showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.', 'warn');
      return;
    }

    try {
      btn.disabled = true;
      btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';

      // Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      const r1 = await fetch(ORDERS_API, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=delete_all_orders`
      });
      const d1 = await r1.json();
      if (!d1.ok) throw new Error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ' + (d1.message || d1.error || ''));

      // Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
      // Ø£ÙˆÙ„Ø§Ù‹: Ø¬Ù„Ø¨ rowIndex Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„
      const r2 = await fetch(CONTRACTOR_API, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=get_contractor&date=${todayStr}`
      });
      const d2 = await r2.json();

      if (d2.ok && d2.rowIndex) {
        // Ø­Ø°Ù Ø§Ù„ØµÙ
        const r3 = await fetch(CONTRACTOR_API, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `action=delete_contractor&rowIndex=${d2.rowIndex}`
        });
        const d3 = await r3.json();
        if (!d3.ok) throw new Error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„: ' + (d3.message || d3.error || ''));
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      document.getElementById('tablesContainer').innerHTML = '';
      empTotal = 0;
      conTotal = 0;
      updateTotalsUI();

      showToast(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ (Ù…ÙˆØ¸ÙÙˆÙ†: ${d1.cleared || 0} | Ù…Ù‚Ø§ÙˆÙ„: ØªÙ…)`, 'success');

    } catch (err) {
      showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + err.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  fetchOrders();
  fetchContractor();
</script>
</body>
</html>
