<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªÙ‚ÙŠÙŠÙ… ÙˆØ¬Ø¨Ø§Øª Ø±Ù…Ø¶Ø§Ù†</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #fdf8ef;
      --surface: #fffdf7;
      --surface2: #fef6e4;
      --border: rgba(180,130,60,0.15);
      --border2: rgba(180,130,60,0.28);
      --gold: #b8760a;
      --gold2: #9a5f00;
      --gold-light: #e8b84d;
      --gold-pale: #fdecc8;
      --rose: #c94444;
      --teal: #2a8a8a;
      --text: #3a2c14;
      --muted: #9a8060;
      --ex: #2e9e5e;
      --good: #2a7aba;
      --avg: #b8760a;
      --bad: #c94444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ====== BACKGROUND ART ====== */
    .bg-art {
      position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden;
    }
    .bg-art::before {
      content: '';
      position: absolute;
      width: 800px; height: 800px;
      top: -250px; right: -200px;
      background: radial-gradient(circle, rgba(232,184,77,0.18) 0%, transparent 70%);
      border-radius: 50%;
    }
    .bg-art::after {
      content: '';
      position: absolute;
      width: 500px; height: 500px;
      bottom: -100px; left: -100px;
      background: radial-gradient(circle, rgba(42,138,138,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    /* Soft warm grain texture */
    .grain {
      position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.04;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    /* Islamic geometric pattern - warm gold tones */
    .pattern-overlay {
      position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.045;
      background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b8760a' fill-opacity='1'%3E%3Cpath d='M40 0l5.77 10H34.23L40 0zm0 80l-5.77-10h11.54L40 80zM0 40l10-5.77V45.77L0 40zm80 0l-10 5.77V34.23L80 40zM40 20l8.66 5v-10L40 20zm0 40l-8.66-5v10L40 60zM20 40l5 8.66h-10L20 40zm40 0l-5-8.66h10L60 40z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    /* decorative top band */
    .top-band {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--teal), var(--gold-light), var(--rose), var(--gold-light), var(--teal));
      z-index: 100;
    }

    /* ====== LAYOUT ====== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 20px;
      position: relative;
      z-index: 1;
    }

    /* ====== HEADER ====== */
    .site-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 30px 36px;
      margin-bottom: 28px;
      background: linear-gradient(135deg, #fffdf7 60%, #fef6e4 100%);
      border: 1.5px solid rgba(184,118,10,0.18);
      border-radius: 22px;
      box-shadow: 0 4px 32px rgba(184,118,10,0.08), 0 1px 4px rgba(184,118,10,0.06);
      position: relative;
      overflow: hidden;
    }
    .site-header::before {
      content: '';
      position: absolute;
      top: 0; right: 0;
      width: 220px; height: 100%;
      background: linear-gradient(270deg, rgba(232,184,77,0.12), transparent);
      pointer-events: none;
    }
    /* Decorative arch at top of header */
    .site-header::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--gold-light), transparent);
    }
    .header-title {
      font-family: 'Amiri', serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--gold2);
      line-height: 1.2;
    }
    .header-sub {
      font-size: 13px;
      color: var(--muted);
      margin-top: 5px;
      font-weight: 500;
    }
    .header-emblem {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .crescent {
      font-size: 52px;
      line-height: 1;
      filter: drop-shadow(0 4px 16px rgba(184,118,10,0.3));
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float {
      0%,100% { transform: translateY(0px); }
      50% { transform: translateY(-7px); }
    }
    .ramadan-text {
      font-family: 'Amiri', serif;
      font-size: 14px;
      color: var(--gold);
      letter-spacing: 1px;
      font-weight: 700;
    }

    /* ====== TABS ====== */
    .tabs-wrapper {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: var(--surface);
      border: 1.5px solid var(--border2);
      border-radius: 16px;
      padding: 6px;
      box-shadow: 0 2px 12px rgba(184,118,10,0.07);
    }
    .tab-btn {
      flex: 1;
      padding: 13px 20px;
      border-radius: 11px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      font-weight: 700;
      font-size: 15px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--gold-pale), #fde9b0);
      color: var(--gold2);
      border: 1.5px solid rgba(184,118,10,0.3);
      box-shadow: 0 2px 12px rgba(184,118,10,0.12);
    }
    .tab-icon { font-size: 18px; }

    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

    /* ====== CARDS ====== */
    .card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 20px;
      padding: 26px;
      margin-bottom: 20px;
      box-shadow: 0 2px 16px rgba(184,118,10,0.06), 0 1px 4px rgba(0,0,0,0.04);
    }
    .card-title {
      font-family: 'Amiri', serif;
      font-size: 19px;
      color: var(--gold2);
      margin-bottom: 22px;
      padding-bottom: 14px;
      border-bottom: 1.5px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-title-icon {
      width: 34px; height: 34px;
      background: var(--gold-pale);
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      box-shadow: 0 1px 6px rgba(184,118,10,0.15);
    }

    /* ====== FORM FIELDS ====== */
    .fields-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .field-group { display: flex; flex-direction: column; gap: 7px; }
    .field-label {
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .field-input {
      background: var(--surface2);
      border: 1.5px solid var(--border2);
      border-radius: 11px;
      padding: 12px 15px;
      color: var(--text);
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
      font-weight: 600;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .field-input:focus {
      border-color: var(--gold-light);
      box-shadow: 0 0 0 3px rgba(232,184,77,0.18);
    }
    .field-input option { background: #fffdf7; color: #3a2c14; }

    /* ====== RATING BUTTONS ====== */
    .criteria-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media(max-width:640px) { .criteria-grid { grid-template-columns: 1fr; } }

    .criterion-card {
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .criterion-card.has-value {
      border-color: rgba(184,118,10,0.4);
      box-shadow: 0 2px 14px rgba(184,118,10,0.1);
    }

    .criterion-label {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .criterion-num {
      width: 24px; height: 24px;
      background: var(--gold-pale);
      color: var(--gold2);
      border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 900;
      box-shadow: 0 1px 4px rgba(184,118,10,0.15);
    }
    .criterion-check {
      display: none;
      width: 20px; height: 20px;
      background: var(--ex);
      border-radius: 50%;
      align-items: center; justify-content: center;
      font-size: 11px; color: white;
      margin-right: auto;
      box-shadow: 0 2px 6px rgba(46,158,94,0.3);
    }
    .criterion-card.has-value .criterion-check { display: flex; }

    .rating-options { display: flex; gap: 8px; }
    .rating-opt {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 11px 6px;
      border-radius: 12px;
      border: 1.5px solid var(--border2);
      background: #fffdf7;
      cursor: pointer;
      transition: all 0.25s;
    }
    .rating-opt:hover { border-color: var(--gold-light); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(184,118,10,0.12); }
    .rating-opt .opt-emoji { font-size: 22px; transition: transform 0.2s; }
    .rating-opt .opt-label { font-size: 10px; font-weight: 800; color: var(--muted); white-space: nowrap; }

    .rating-opt[data-val="Ù…Ù…ØªØ§Ø²"].active { background: rgba(46,158,94,0.1); border-color: #2e9e5e; box-shadow: 0 3px 12px rgba(46,158,94,0.2); }
    .rating-opt[data-val="Ù…Ù…ØªØ§Ø²"].active .opt-label { color: #2e9e5e; }
    .rating-opt[data-val="Ù…Ù…ØªØ§Ø²"].active .opt-emoji { transform: scale(1.2); }

    .rating-opt[data-val="Ø¬ÙŠØ¯"].active { background: rgba(42,122,186,0.1); border-color: #2a7aba; box-shadow: 0 3px 12px rgba(42,122,186,0.2); }
    .rating-opt[data-val="Ø¬ÙŠØ¯"].active .opt-label { color: #2a7aba; }
    .rating-opt[data-val="Ø¬ÙŠØ¯"].active .opt-emoji { transform: scale(1.2); }

    .rating-opt[data-val="Ù…Ù‚Ø¨ÙˆÙ„"].active { background: rgba(184,118,10,0.1); border-color: var(--gold); box-shadow: 0 3px 12px rgba(184,118,10,0.2); }
    .rating-opt[data-val="Ù…Ù‚Ø¨ÙˆÙ„"].active .opt-label { color: var(--gold); }
    .rating-opt[data-val="Ù…Ù‚Ø¨ÙˆÙ„"].active .opt-emoji { transform: scale(1.2); }

    .rating-opt[data-val="Ø¶Ø¹ÙŠÙ"].active { background: rgba(201,68,68,0.1); border-color: var(--rose); box-shadow: 0 3px 12px rgba(201,68,68,0.2); }
    .rating-opt[data-val="Ø¶Ø¹ÙŠÙ"].active .opt-label { color: var(--rose); }
    .rating-opt[data-val="Ø¶Ø¹ÙŠÙ"].active .opt-emoji { transform: scale(1.2); }

    /* ====== SCORE PREVIEW ====== */
    .score-preview {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, var(--gold-pale), #fde9b0);
      border: 1.5px solid rgba(184,118,10,0.22);
      border-radius: 14px;
      padding: 16px 22px;
      margin-bottom: 18px;
      box-shadow: 0 2px 10px rgba(184,118,10,0.1);
    }
    .score-label { font-size: 13px; color: var(--gold); font-weight: 700; }
    .score-value { font-family: 'Amiri', serif; font-size: 26px; color: var(--gold2); font-weight: 700; min-width: 90px; text-align: left; }
    .score-meter {
      flex: 1;
      margin: 0 20px;
      height: 9px;
      background: rgba(184,118,10,0.12);
      border-radius: 99px;
      overflow: hidden;
    }
    .score-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--rose), var(--avg), var(--ex));
      border-radius: 99px;
      transition: width 0.5s cubic-bezier(.4,0,.2,1);
      width: 0%;
    }

    /* ====== NOTES & SUBMIT ====== */
    textarea.field-input {
      min-height: 90px;
      resize: vertical;
      width: 100%;
    }
    .submit-btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 13px;
      background: linear-gradient(135deg, #b8760a, #d4960e, #e8b84d);
      color: #fff;
      font-family: 'Tajawal', sans-serif;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.5px;
      margin-top: 14px;
      box-shadow: 0 6px 22px rgba(184,118,10,0.28);
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(184,118,10,0.38); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* ====== ANALYTICS STATS ====== */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    @media(max-width:700px) { .stats-row { grid-template-columns: repeat(2,1fr); } }

    .stat-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
    }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(184,118,10,0.1); }
    .stat-emoji { font-size: 24px; }
    .stat-num { font-family: 'Amiri', serif; font-size: 34px; font-weight: 700; line-height: 1; }
    .stat-card.total .stat-num { color: var(--gold2); }
    .stat-card.ex .stat-num { color: var(--ex); }
    .stat-card.good .stat-num { color: var(--good); }
    .stat-card.avg .stat-num { color: var(--avg); }
    .stat-card.bad .stat-num { color: var(--bad); }
    .stat-lbl { font-size: 12px; color: var(--muted); font-weight: 700; }

    /* Filters */
    .filters-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .filters-row .field-input { flex: 1; min-width: 160px; }

    /* Charts */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    @media(max-width:700px) { .charts-grid { grid-template-columns: 1fr; } }

    .chart-box {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
    }
    .chart-box.wide { grid-column: 1 / -1; }
    .chart-title {
      font-size: 13px;
      font-weight: 800;
      color: var(--muted);
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Stacked bars */
    .cat-bars { display: flex; flex-direction: column; gap: 12px; }
    .cat-row { display: flex; flex-direction: column; gap: 6px; }
    .cat-name { font-size: 12px; font-weight: 800; color: var(--muted); }
    .cat-bar-track {
      height: 28px;
      background: rgba(184,118,10,0.07);
      border-radius: 7px;
      display: flex;
      overflow: hidden;
      gap: 2px;
    }
    .cat-seg { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: rgba(255,255,255,0.9); transition: width 0.6s cubic-bezier(.4,0,.2,1); min-width: 0; overflow: hidden; white-space: nowrap; }
    .cat-seg.ex   { background: var(--ex); border-radius: 5px 0 0 5px; }
    .cat-seg.good { background: var(--good); }
    .cat-seg.avg  { background: var(--avg); }
    .cat-seg.bad  { background: var(--bad); border-radius: 0 5px 5px 0; }

    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: var(--gold-pale);
      color: var(--gold2);
      padding: 13px 11px;
      font-size: 12px;
      font-weight: 800;
      border-bottom: 2px solid rgba(184,118,10,0.2);
      white-space: nowrap;
      text-align: right;
    }
    tbody td { padding: 12px 11px; font-size: 13px; color: var(--text); border-bottom: 1px solid var(--border); }
    tbody tr:hover { background: var(--surface2); }
    .badge-val { display: inline-block; padding: 4px 11px; border-radius: 20px; font-size: 11px; font-weight: 800; }
    .badge-val.Ù…Ù…ØªØ§Ø² { background: rgba(46,158,94,0.13); color: var(--ex); border: 1px solid rgba(46,158,94,0.3); }
    .badge-val.Ø¬ÙŠØ¯   { background: rgba(42,122,186,0.13); color: var(--good); border: 1px solid rgba(42,122,186,0.3); }
    .badge-val.Ù…Ù‚Ø¨ÙˆÙ„ { background: rgba(184,118,10,0.13); color: var(--avg); border: 1px solid rgba(184,118,10,0.3); }
    .badge-val.Ø¶Ø¹ÙŠÙ  { background: rgba(201,68,68,0.13); color: var(--bad); border: 1px solid rgba(201,68,68,0.3); }

    /* ====== TOAST ====== */
    .toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--surface);
      border: 1.5px solid var(--border2);
      color: var(--text);
      padding: 14px 26px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.12);
      transition: transform 0.35s cubic-bezier(.4,0,.2,1);
      z-index: 999;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.success { border-color: rgba(46,158,94,0.4); }
    .toast.error { border-color: rgba(201,68,68,0.4); }

    /* ====== LOADING STATE ====== */
    .loading-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 14px;
      background: linear-gradient(135deg, var(--gold-pale), #fde9b0);
      border: 1.5px solid rgba(184,118,10,0.25);
      border-radius: 14px;
      padding: 14px 22px;
      margin-bottom: 18px;
      font-weight: 700;
      color: var(--gold2);
      font-size: 15px;
      box-shadow: 0 2px 12px rgba(184,118,10,0.1);
    }
    .loading-banner.visible { display: flex; }
    .loading-icons {
      display: flex;
      gap: 6px;
    }
    .loading-icons span {
      font-size: 20px;
      animation: ramadan-pulse 1.4s ease-in-out infinite;
    }
    .loading-icons span:nth-child(2) { animation-delay: 0.2s; }
    .loading-icons span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes ramadan-pulse {
      0%, 100% { opacity: 0.25; transform: scale(0.85); }
      50%       { opacity: 1;    transform: scale(1.1); }
    }

    /* Stat shimmer when loading */
    .stat-num.loading-num {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }
    .stat-num.loading-num::after {
      content: attr(data-icon);
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      animation: ramadan-pulse 1.4s ease-in-out infinite;
      color: inherit;
    }
    .stat-card.total .stat-num.loading-num::after  { color: var(--gold2); }
    .stat-card.ex    .stat-num.loading-num::after  { color: var(--ex); }
    .stat-card.good  .stat-num.loading-num::after  { color: var(--good); }
    .stat-card.avg   .stat-num.loading-num::after  { color: var(--avg); }
    .stat-card.bad   .stat-num.loading-num::after  { color: var(--bad); }

    /* Table loading skeleton row */
    .table-loading-row td {
      padding: 14px 11px;
      text-align: center;
      color: var(--muted);
      font-size: 20px;
      letter-spacing: 8px;
    }
    .table-loading-row .tl-icons span {
      animation: ramadan-pulse 1.4s ease-in-out infinite;
    }
    .table-loading-row .tl-icons span:nth-child(2) { animation-delay: 0.25s; }
    .table-loading-row .tl-icons span:nth-child(3) { animation-delay: 0.5s; }

    /* Table â€” normal layout, rows rendered in reverse order via JS */
    .table-wrap { overflow-x: auto; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--surface2); }
    ::-webkit-scrollbar-thumb { background: rgba(184,118,10,0.3); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(184,118,10,0.5); }
  </style>
</head>
<body>

<div class="top-band"></div>
<div class="bg-art"></div>
<div class="grain"></div>
<div class="pattern-overlay"></div>

<div class="container">

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-left">
      <div class="header-title">Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… ÙˆØ¬Ø¨Ø§Øª Ø±Ù…Ø¶Ø§Ù†</div>
      <div class="header-sub">ÙØ¶Ù„Ø§Ù‹ Ù‚Ù… Ø¨Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¯Ø¹Ù… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø©</div>
    </div>
    <div class="header-emblem">
      <div class="crescent">ğŸŒ™</div>
      <div class="ramadan-text">Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…</div>
    </div>
  </header>

  <!-- TABS -->
  <div class="tabs-wrapper">
    <button class="tab-btn active" data-tab="form">
      <span class="tab-icon">ğŸ“</span> ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
    </button>
    <button class="tab-btn" data-tab="analytics">
      <span class="tab-icon">ğŸ“Š</span> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„
    </button>
  </div>

  <!-- ===================== FORM ===================== -->
  <div id="form" class="tab-content active">

    <div class="card">
      <div class="card-title">
        <div class="card-title-icon">ğŸ“‹</div>
        Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      </div>
      <div class="fields-grid">
        <div class="field-group">
          <div class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
          <input type="text" id="dateInput" class="field-input" readonly>
        </div>
        <div class="field-group">
          <div class="field-label">Ø§Ù„ÙŠÙˆÙ…</div>
          <input type="text" id="dayLabel" class="field-input" readonly>
        </div>
        <div class="field-group">
          <div class="field-label">Ø§Ù„Ø§Ø³Ù…</div>
          <input type="text" id="nameInput" class="field-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
        </div>
        <div class="field-group">
          <div class="field-label">Ø§Ù„Ù‚Ø³Ù…</div>
          <select id="deptSelect" class="field-input">
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <div class="card-title-icon">â­</div>
        ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙˆØ¬Ø¨Ø©
      </div>

      <div class="score-preview">
        <div><div class="score-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒÙ„ÙŠ</div></div>
        <div class="score-meter"><div class="score-fill" id="scoreFill"></div></div>
        <div class="score-value" id="scoreText">â€”</div>
      </div>

      <div class="criteria-grid">
        <div class="criterion-card" id="crit-quality">
          <div class="criterion-label">
            <div class="criterion-num">Ù¡</div>
            Ø¬ÙˆØ¯Ø© Ø§Ù„Ø·Ø¹Ø§Ù…
            <div class="criterion-check">âœ“</div>
          </div>
          <div class="rating-options" data-key="quality">
            <div class="rating-opt" data-val="Ù…Ù…ØªØ§Ø²"><div class="opt-emoji">ğŸ¤©</div><div class="opt-label">Ù…Ù…ØªØ§Ø²</div></div>
            <div class="rating-opt" data-val="Ø¬ÙŠØ¯"><div class="opt-emoji">ğŸ˜Š</div><div class="opt-label">Ø¬ÙŠØ¯</div></div>
            <div class="rating-opt" data-val="Ù…Ù‚Ø¨ÙˆÙ„"><div class="opt-emoji">ğŸ˜</div><div class="opt-label">Ù…Ù‚Ø¨ÙˆÙ„</div></div>
            <div class="rating-opt" data-val="Ø¶Ø¹ÙŠÙ"><div class="opt-emoji">ğŸ˜</div><div class="opt-label">Ø¶Ø¹ÙŠÙ</div></div>
          </div>
        </div>

        <div class="criterion-card" id="crit-taste">
          <div class="criterion-label">
            <div class="criterion-num">Ù¢</div>
            Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ°ÙˆÙ‚
            <div class="criterion-check">âœ“</div>
          </div>
          <div class="rating-options" data-key="taste">
            <div class="rating-opt" data-val="Ù…Ù…ØªØ§Ø²"><div class="opt-emoji">ğŸ˜‹</div><div class="opt-label">Ù…Ù…ØªØ§Ø²</div></div>
            <div class="rating-opt" data-val="Ø¬ÙŠØ¯"><div class="opt-emoji">ğŸ™‚</div><div class="opt-label">Ø¬ÙŠØ¯</div></div>
            <div class="rating-opt" data-val="Ù…Ù‚Ø¨ÙˆÙ„"><div class="opt-emoji">ğŸ˜‘</div><div class="opt-label">Ù…Ù‚Ø¨ÙˆÙ„</div></div>
            <div class="rating-opt" data-val="Ø¶Ø¹ÙŠÙ"><div class="opt-emoji">ğŸ¤¢</div><div class="opt-label">Ø¶Ø¹ÙŠÙ</div></div>
          </div>
        </div>

        <div class="criterion-card" id="crit-portions">
          <div class="criterion-label">
            <div class="criterion-num">Ù£</div>
            Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
            <div class="criterion-check">âœ“</div>
          </div>
          <div class="rating-options" data-key="portions">
            <div class="rating-opt" data-val="Ù…Ù…ØªØ§Ø²"><div class="opt-emoji">ğŸ½ï¸</div><div class="opt-label">Ù…Ù…ØªØ§Ø²</div></div>
            <div class="rating-opt" data-val="Ø¬ÙŠØ¯"><div class="opt-emoji">ğŸ¥˜</div><div class="opt-label">Ø¬ÙŠØ¯</div></div>
            <div class="rating-opt" data-val="Ù…Ù‚Ø¨ÙˆÙ„"><div class="opt-emoji">ğŸ¥—</div><div class="opt-label">Ù…Ù‚Ø¨ÙˆÙ„</div></div>
            <div class="rating-opt" data-val="Ø¶Ø¹ÙŠÙ"><div class="opt-emoji">ğŸœ</div><div class="opt-label">Ø¶Ø¹ÙŠÙ</div></div>
          </div>
        </div>

        <div class="criterion-card" id="crit-presentation">
          <div class="criterion-label">
            <div class="criterion-num">Ù¤</div>
            Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù…
            <div class="criterion-check">âœ“</div>
          </div>
          <div class="rating-options" data-key="presentation">
            <div class="rating-opt" data-val="Ù…Ù…ØªØ§Ø²"><div class="opt-emoji">âœ¨</div><div class="opt-label">Ù…Ù…ØªØ§Ø²</div></div>
            <div class="rating-opt" data-val="Ø¬ÙŠØ¯"><div class="opt-emoji">ğŸ‘Œ</div><div class="opt-label">Ø¬ÙŠØ¯</div></div>
            <div class="rating-opt" data-val="Ù…Ù‚Ø¨ÙˆÙ„"><div class="opt-emoji">ğŸ‘</div><div class="opt-label">Ù…Ù‚Ø¨ÙˆÙ„</div></div>
            <div class="rating-opt" data-val="Ø¶Ø¹ÙŠÙ"><div class="opt-emoji">ğŸ‘</div><div class="opt-label">Ø¶Ø¹ÙŠÙ</div></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <div class="card-title-icon">ğŸ’¬</div>
        Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© <span style="color:var(--muted);font-size:13px;font-weight:400;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
      </div>
      <textarea id="notesInput" class="field-input" placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ Ø±Ø£ÙŠÙƒ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø©..."></textarea>
      <button class="submit-btn" id="submitBtn" onclick="submitForm()">
        ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      </button>
    </div>

  </div>

  <!-- ===================== ANALYTICS ===================== -->
  <div id="analytics" class="tab-content">

    <!-- Loading Banner -->
    <div class="loading-banner" id="loadingBanner">
      <div class="loading-icons">
        <span>ğŸŒ™</span><span>â­</span><span>ğŸ•Œ</span>
      </div>
      <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
      <div class="loading-icons">
        <span>ğŸ•Œ</span><span>â­</span><span>ğŸŒ™</span>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card total"><div class="stat-emoji">ğŸ“Œ</div><div class="stat-num" id="statTotal" data-icon="ğŸŒ™">â€”</div><div class="stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div></div>
      <div class="stat-card ex"><div class="stat-emoji">ğŸŒŸ</div><div class="stat-num" id="statEx" data-icon="â­">â€”</div><div class="stat-lbl">Ù…Ù…ØªØ§Ø²</div></div>
      <div class="stat-card good"><div class="stat-emoji">ğŸ‘</div><div class="stat-num" id="statGood" data-icon="ğŸ•Œ">â€”</div><div class="stat-lbl">Ø¬ÙŠØ¯</div></div>
      <div class="stat-card avg"><div class="stat-emoji">ğŸ‘Œ</div><div class="stat-num" id="statAvg" data-icon="ğŸª”">â€”</div><div class="stat-lbl">Ù…Ù‚Ø¨ÙˆÙ„</div></div>
      <div class="stat-card bad"><div class="stat-emoji">âš ï¸</div><div class="stat-num" id="statBad" data-icon="ğŸ“¿">â€”</div><div class="stat-lbl">Ø¶Ø¹ÙŠÙ</div></div>
    </div>

    <div class="card">
      <div class="card-title"><div class="card-title-icon">ğŸ”</div>ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>
      <div class="filters-row">
        <input type="date" id="analyticsDate" class="field-input" style="flex:0 0 180px">
        <select id="analyticsDept" class="field-input"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option></select>
        <input type="text" id="searchEval" class="field-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...">
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-box">
        <div class="chart-title">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ</div>
        <select id="categorySelect" class="field-input" style="margin-bottom:14px;width:100%;font-size:13px;">
          <option value="quality">Ø¬ÙˆØ¯Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</option>
          <option value="taste">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ°ÙˆÙ‚</option>
          <option value="portions">Ø§Ù„ÙƒÙ…ÙŠØ§Øª</option>
          <option value="presentation">Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù…</option>
        </select>
        <canvas id="donutChart" height="220"></canvas>
      </div>

      <div class="chart-box">
        <div class="chart-title">ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø±</div>
        <div class="cat-bars" id="catBars">
          <div class="cat-row"><div class="cat-name">Ø¬ÙˆØ¯Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</div><div class="cat-bar-track"><div class="cat-seg ex" id="bar-quality-ex" style="width:0%"></div><div class="cat-seg good" id="bar-quality-good" style="width:0%"></div><div class="cat-seg avg" id="bar-quality-avg" style="width:0%"></div><div class="cat-seg bad" id="bar-quality-bad" style="width:0%"></div></div></div>
          <div class="cat-row"><div class="cat-name">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ°ÙˆÙ‚</div><div class="cat-bar-track"><div class="cat-seg ex" id="bar-taste-ex" style="width:0%"></div><div class="cat-seg good" id="bar-taste-good" style="width:0%"></div><div class="cat-seg avg" id="bar-taste-avg" style="width:0%"></div><div class="cat-seg bad" id="bar-taste-bad" style="width:0%"></div></div></div>
          <div class="cat-row"><div class="cat-name">Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</div><div class="cat-bar-track"><div class="cat-seg ex" id="bar-portions-ex" style="width:0%"></div><div class="cat-seg good" id="bar-portions-good" style="width:0%"></div><div class="cat-seg avg" id="bar-portions-avg" style="width:0%"></div><div class="cat-seg bad" id="bar-portions-bad" style="width:0%"></div></div></div>
          <div class="cat-row"><div class="cat-name">Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù…</div><div class="cat-bar-track"><div class="cat-seg ex" id="bar-presentation-ex" style="width:0%"></div><div class="cat-seg good" id="bar-presentation-good" style="width:0%"></div><div class="cat-seg avg" id="bar-presentation-avg" style="width:0%"></div><div class="cat-seg bad" id="bar-presentation-bad" style="width:0%"></div></div></div>
        </div>
      </div>

      <div class="chart-box wide">
        <div class="chart-title">ğŸ“… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ø£ÙŠØ§Ù…</div>
        <canvas id="lineChart" height="100"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><div class="card-title-icon">ğŸ—‚ï¸</div>Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th>
              <th>Ø§Ù„Ø¬ÙˆØ¯Ø©</th><th>Ø§Ù„ØªØ°ÙˆÙ‚</th><th>Ø§Ù„ÙƒÙ…ÙŠØ§Øª</th><th>Ø§Ù„Ù…Ø¸Ù‡Ø±</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <tr class="table-loading-row">
              <td colspan="10">
                <div class="tl-icons" style="display:flex;align-items:center;justify-content:center;gap:10px;padding:8px 0;">
                  <span>ğŸŒ™</span><span>â­</span><span>ğŸ•Œ</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIUGNXTUBjdikikZkwXh6mIWhZ3CTz_CKraMa9do7WkcfTlN5pny8V9-VUBlssnskjYA/exec";

const DEPARTMENTS = [
  "Administration","Electrical & Instrumentation","Finished Products","HSE",
  "Mechanical Maintenance","Packing","Production","Quality","Vehicle Workshop",
  "Utilities","Supply Planning","Spare Parts W/H","Projects","Logistics","Export","Costing"
];

const SCORE_MAP = { Ù…Ù…ØªØ§Ø²:4, Ø¬ÙŠØ¯:3, Ù…Ù‚Ø¨ÙˆÙ„:2, Ø¶Ø¹ÙŠÙ:1 };
const KEYS = ["quality","taste","portions","presentation"];

function showToast(msg, type="") {
  const t = document.getElementById("toast");
  t.textContent = msg; t.className = "toast " + type;
  setTimeout(() => t.classList.add("show"), 20);
  setTimeout(() => t.classList.remove("show"), 3500);
}

document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    document.getElementById(tab).classList.add("active");
    if (tab === "analytics") loadAnalytics();
  });
});

function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function dayNameAr(ds) { return new Date(ds).toLocaleDateString("ar-EG", { weekday:"long" }); }

(function initForm() {
  const sel = document.getElementById("deptSelect");
  sel.innerHTML = `<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>` + DEPARTMENTS.map(d => `<option>${d}</option>`).join("");
  document.getElementById("dateInput").value = todayStr();
  document.getElementById("dayLabel").value = dayNameAr(todayStr());
  const asel = document.getElementById("analyticsDept");
  asel.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>` + DEPARTMENTS.map(d => `<option>${d}</option>`).join("");
  document.querySelectorAll(".rating-options").forEach(group => {
    group.querySelectorAll(".rating-opt").forEach(opt => {
      opt.addEventListener("click", () => {
        group.querySelectorAll(".rating-opt").forEach(o => o.classList.remove("active"));
        opt.classList.add("active");
        const card = document.getElementById("crit-"+group.dataset.key);
        if (card) card.classList.add("has-value");
        updateScorePreview();
      });
    });
  });
})();

function updateScorePreview() {
  let total = 0, count = 0;
  KEYS.forEach(k => {
    const active = document.querySelector(`.rating-options[data-key="${k}"] .rating-opt.active`);
    if (active) { total += SCORE_MAP[active.dataset.val] || 0; count++; }
  });
  const fill = document.getElementById("scoreFill");
  const text = document.getElementById("scoreText");
  if (count === 0) { fill.style.width = "0%"; text.textContent = "â€”"; return; }
  const pct = ((total / (count * 4)) * 100).toFixed(0);
  fill.style.width = pct + "%";
  const avg = total / count;
  if (avg >= 3.5) text.textContent = "Ù…Ù…ØªØ§Ø² ğŸŒŸ";
  else if (avg >= 2.5) text.textContent = "Ø¬ÙŠØ¯ ğŸ‘";
  else if (avg >= 1.5) text.textContent = "Ù…Ù‚Ø¨ÙˆÙ„ ğŸ‘Œ";
  else text.textContent = "Ø¶Ø¹ÙŠÙ âš ï¸";
}

function getRatings() {
  const r = {};
  KEYS.forEach(k => {
    const active = document.querySelector(`.rating-options[data-key="${k}"] .rating-opt.active`);
    r[k] = active ? active.dataset.val : "";
  });
  return r;
}

function validateForm(data) {
  const miss = [];
  if (!data.name) miss.push("Ø§Ù„Ø§Ø³Ù…");
  if (!data.department) miss.push("Ø§Ù„Ù‚Ø³Ù…");
  if (!data.ratings.quality) miss.push("Ø¬ÙˆØ¯Ø© Ø§Ù„Ø·Ø¹Ø§Ù…");
  if (!data.ratings.taste) miss.push("Ø§Ù„ØªØ°ÙˆÙ‚");
  if (!data.ratings.portions) miss.push("Ø§Ù„ÙƒÙ…ÙŠØ§Øª");
  if (!data.ratings.presentation) miss.push("Ø§Ù„Ù…Ø¸Ù‡Ø±");
  return miss;
}

async function submitForm() {
  const btn = document.getElementById("submitBtn");
  const payload = {
    date: document.getElementById("dateInput").value,
    day: document.getElementById("dayLabel").value,
    name: document.getElementById("nameInput").value.trim(),
    department: document.getElementById("deptSelect").value,
    ratings: getRatings(),
    notes: document.getElementById("notesInput").value.trim()
  };
  const miss = validateForm(payload);
  if (miss.length) { showToast("âš ï¸ Ø£ÙƒÙ…Ù„: " + miss.join("ØŒ ")); return; }
  btn.disabled = true; btn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded" },
      body: new URLSearchParams({ action:"save_performance", row:JSON.stringify(payload) })
    });
    const out = await res.json();
    if (!out.ok) throw new Error(out.message || "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
    showToast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­", "success");
    document.getElementById("nameInput").value = "";
    document.getElementById("deptSelect").value = "";
    document.getElementById("notesInput").value = "";
    document.querySelectorAll(".rating-opt").forEach(o => o.classList.remove("active"));
    document.querySelectorAll(".criterion-card").forEach(c => c.classList.remove("has-value"));
    updateScorePreview();
  } catch (err) { showToast("âŒ " + err.message, "error"); }
  btn.disabled = false; btn.textContent = "ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…";
}

let ALL_DATA = [];
let donutChart, lineChart;

async function loadAnalytics() {
  // Show loading state
  document.getElementById("loadingBanner").classList.add("visible");
  ["statTotal","statEx","statGood","statAvg","statBad"].forEach(id => {
    const el = document.getElementById(id);
    el.classList.add("loading-num");
    el.textContent = "";
  });
  document.getElementById("resultsBody").innerHTML = `
    <tr class="table-loading-row">
      <td colspan="10">
        <div class="tl-icons" style="display:flex;align-items:center;justify-content:center;gap:10px;padding:10px 0;">
          <span>ğŸŒ™</span><span>â­</span><span>ğŸ•Œ</span>
        </div>
      </td>
    </tr>`;

  try {
    const res = await fetch(SCRIPT_URL, { method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body:"action=get_performance" });
    const out = await res.json();
    if (!out.ok) throw new Error(out.error);
    ALL_DATA = out.data || [];
  } catch (err) {
    showToast("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„", "error");
    ALL_DATA = [];
  }

  // Hide loading state
  document.getElementById("loadingBanner").classList.remove("visible");
  ["statTotal","statEx","statGood","statAvg","statBad"].forEach(id => {
    document.getElementById(id).classList.remove("loading-num");
  });

  renderAnalytics();
}

function filterData() {
  const date = document.getElementById("analyticsDate").value;
  const dept = document.getElementById("analyticsDept").value;
  const search = document.getElementById("searchEval").value.trim().toLowerCase();
  return ALL_DATA.filter(r => {
    if (date && r.Date !== date) return false;
    if (dept && r.Department !== dept) return false;
    if (search) { const blob = (r.Name + " " + r["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]).toLowerCase(); if (!blob.includes(search)) return false; }
    return true;
  });
}

function count(list, field) {
  const c = { Ù…Ù…ØªØ§Ø²:0, Ø¬ÙŠØ¯:0, Ù…Ù‚Ø¨ÙˆÙ„:0, Ø¶Ø¹ÙŠÙ:0 };
  list.forEach(r => { const v = r[field]; if (c[v] !== undefined) c[v]++; });
  return c;
}

const FIELD_MAP = {
  quality:"Ù…Ø³ØªÙˆÙ‰ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø·Ø¹Ø§Ù…", taste:"Ù…Ø³ØªÙˆÙ‰ ØªØ°ÙˆÙ‚ Ø§Ù„Ø·Ø¹Ø§Ù…",
  portions:"Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ø¹ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª", presentation:"Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„ÙˆØ¬Ø¨Ø§Øª"
};

function renderAnalytics() {
  const list = filterData();
  const allVals = list.flatMap(r => KEYS.map(k => r[FIELD_MAP[k]]));
  const tot = { Ù…Ù…ØªØ§Ø²:0, Ø¬ÙŠØ¯:0, Ù…Ù‚Ø¨ÙˆÙ„:0, Ø¶Ø¹ÙŠÙ:0 };
  allVals.forEach(v => { if (tot[v] !== undefined) tot[v]++; });
  document.getElementById("statTotal").textContent = list.length;
  document.getElementById("statEx").textContent = tot.Ù…Ù…ØªØ§Ø²;
  document.getElementById("statGood").textContent = tot.Ø¬ÙŠØ¯;
  document.getElementById("statAvg").textContent = tot.Ù…Ù‚Ø¨ÙˆÙ„;
  document.getElementById("statBad").textContent = tot.Ø¶Ø¹ÙŠÙ;

  KEYS.forEach(k => {
    const c = count(list, FIELD_MAP[k]);
    const total = list.length || 1;
    ["ex","good","avg","bad"].forEach((cls, i) => {
      const labels = ["Ù…Ù…ØªØ§Ø²","Ø¬ÙŠØ¯","Ù…Ù‚Ø¨ÙˆÙ„","Ø¶Ø¹ÙŠÙ"];
      const el = document.getElementById(`bar-${k}-${cls}`);
      if (el) { const pct = (c[labels[i]] / total * 100); el.style.width = pct + "%"; el.textContent = pct > 8 ? Math.round(pct) + "%" : ""; }
    });
  });

  const selField = FIELD_MAP[document.getElementById("categorySelect").value];
  const dc = count(list, selField);
  if (donutChart) donutChart.destroy();
  donutChart = new Chart(document.getElementById("donutChart"), {
    type: "doughnut",
    data: {
      labels: ["Ù…Ù…ØªØ§Ø²","Ø¬ÙŠØ¯","Ù…Ù‚Ø¨ÙˆÙ„","Ø¶Ø¹ÙŠÙ"],
      datasets: [{
        data: [dc.Ù…Ù…ØªØ§Ø², dc.Ø¬ÙŠØ¯, dc.Ù…Ù‚Ø¨ÙˆÙ„, dc.Ø¶Ø¹ÙŠÙ],
        backgroundColor: ["#2e9e5e","#2a7aba","#b8760a","#c94444"],
        borderColor: "#fffdf7", borderWidth: 3, hoverOffset: 6
      }]
    },
    options: {
      cutout: "65%",
      plugins: { legend: { position:"bottom", labels:{ color:"#3a2c14", font:{family:"Tajawal",size:12,weight:"700"}, padding:12 } } }
    }
  });

  const byDate = {};
  list.forEach(r => { byDate[r.Date] = (byDate[r.Date]||0) + 1; });
  const sortedDates = Object.keys(byDate).sort();
  if (lineChart) lineChart.destroy();
  lineChart = new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: {
      labels: sortedDates,
      datasets: [{
        label: "Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª",
        data: sortedDates.map(d => byDate[d]),
        borderColor: "#b8760a",
        backgroundColor: "rgba(184,118,10,0.08)",
        tension: 0.4, fill: true,
        pointBackgroundColor: "#b8760a", pointRadius: 5, pointHoverRadius: 7
      }]
    },
    options: {
      scales: {
        x: { ticks:{color:"#9a8060",font:{family:"Tajawal"}}, grid:{color:"rgba(184,118,10,0.07)"} },
        y: { ticks:{color:"#9a8060",font:{family:"Tajawal"}}, grid:{color:"rgba(184,118,10,0.07)"}, beginAtZero:true }
      },
      plugins: { legend: { labels:{ color:"#3a2c14", font:{family:"Tajawal",weight:"700"} } } }
    }
  });

  const body = document.getElementById("resultsBody");
  body.innerHTML = "";
  if (list.length === 0) {
    body.innerHTML = `<tr class="table-loading-row"><td colspan="10"><div style="text-align:center;color:var(--muted);padding:18px 0;font-size:14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</div></td></tr>`;
  } else {
    // Render from last to first so row #1 appears at the bottom
    for (let i = list.length - 1; i >= 0; i--) {
      const r = list[i];
      const num = i + 1;
      const vals = KEYS.map(k => `<td><span class="badge-val ${r[FIELD_MAP[k]]}">${r[FIELD_MAP[k]]||"â€”"}</span></td>`).join("");
      body.innerHTML += `<tr><td>${num}</td><td>${r.Date||""}</td><td>${r.Day||""}</td><td>${r.Name||""}</td><td>${r.Department||""}</td>${vals}<td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${r["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]||""}">${r["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]||"â€”"}</td></tr>`;
    }
  }
}

document.querySelectorAll("#analyticsDate,#analyticsDept,#categorySelect").forEach(el => el.addEventListener("change", renderAnalytics));
document.getElementById("searchEval").addEventListener("input", renderAnalytics);
</script>
</body>
</html>
