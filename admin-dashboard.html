<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:         #fdf8ef;
      --surface:    #fffdf7;
      --surface2:   #fef6e4;
      --border:     rgba(180,130,60,0.15);
      --border2:    rgba(180,130,60,0.28);
      --gold:       #b8760a;
      --gold2:      #9a5f00;
      --gold-light: #e8b84d;
      --gold-pale:  #fdecc8;
      --rose:       #c94444;
      --teal:       #2a8a8a;
      --green:      #2e9e5e;
      --blue:       #2a7aba;
      --text:       #3a2c14;
      --muted:      #9a8060;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ BACKGROUND â”€â”€ */
    .bg-art {
      position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden;
    }
    .bg-art::before {
      content: '';
      position: absolute;
      width: 800px; height: 800px;
      top: -250px; right: -200px;
      background: radial-gradient(circle, rgba(232,184,77,0.18) 0%, transparent 70%);
      border-radius: 50%;
    }
    .bg-art::after {
      content: '';
      position: absolute;
      width: 500px; height: 500px;
      bottom: -100px; left: -100px;
      background: radial-gradient(circle, rgba(42,138,138,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }
    .grain {
      position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.04;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }
    .pattern-overlay {
      position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.045;
      background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b8760a' fill-opacity='1'%3E%3Cpath d='M40 0l5.77 10H34.23L40 0zm0 80l-5.77-10h11.54L40 80zM0 40l10-5.77V45.77L0 40zm80 0l-10 5.77V34.23L80 40zM40 20l8.66 5v-10L40 20zm0 40l-8.66-5v10L40 60zM20 40l5 8.66h-10L20 40zm40 0l-5-8.66h10L60 40z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    .top-band {
      position: fixed; top: 0; left: 0; right: 0; height: 4px; z-index: 200;
      background: linear-gradient(90deg, var(--teal), var(--gold-light), var(--rose), var(--gold-light), var(--teal));
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      position: relative; z-index: 10;
      padding: 22px 36px; margin-top: 4px;
      background: linear-gradient(135deg, #fffdf7 60%, #fef6e4 100%);
      border-bottom: 1.5px solid var(--border2);
      box-shadow: 0 4px 24px rgba(184,118,10,0.08);
      display: flex; align-items: center;
      justify-content: space-between; flex-wrap: wrap; gap: 14px;
    }
    header::after {
      content: '';
      position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold-light), transparent);
    }

    .header-left { display: flex; align-items: center; gap: 14px; }

    .logo-icon {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      border-radius: 13px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
      box-shadow: 0 4px 16px rgba(184,118,10,0.28);
    }

    .header-title h1 {
      font-family: 'Amiri', serif;
      font-size: 20px; font-weight: 700;
      color: var(--gold2); line-height: 1.2;
    }
    .header-title p { font-size: 12px; color: var(--muted); margin-top: 3px; font-weight: 500; }

    .dept-badge {
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: white; padding: 6px 18px; border-radius: 30px;
      font-size: 13px; font-weight: 700; letter-spacing: 0.5px;
      box-shadow: 0 3px 12px rgba(184,118,10,0.28);
    }

    .user-info { display: flex; align-items: center; gap: 10px; }

    .avatar {
      width: 38px; height: 38px;
      background: linear-gradient(135deg, var(--gold), var(--teal));
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; font-weight: 800; color: white;
      box-shadow: 0 2px 10px rgba(184,118,10,0.2);
    }

    .user-details span { display: block; font-size: 13px; font-weight: 700; color: var(--text); }
    .user-details small { font-size: 11px; color: var(--muted); }

    .logout-btn {
      background: rgba(201,68,68,0.08);
      border: 1.5px solid rgba(201,68,68,0.3);
      color: var(--rose); padding: 8px 18px; border-radius: 9px;
      cursor: pointer; font-family: 'Tajawal', sans-serif;
      font-size: 13px; font-weight: 700; transition: all 0.25s;
    }
    .logout-btn:hover { background: var(--rose); color: white; }

    /* â”€â”€ MAIN â”€â”€ */
    main {
      position: relative; z-index: 1;
      padding: 28px 36px; max-width: 1200px; margin: 0 auto;
    }

    /* â”€â”€ STAT CARDS â”€â”€ */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px; margin-bottom: 28px;
    }

    .stat-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 16px; padding: 20px 22px;
      display: flex; align-items: center; gap: 14px;
      box-shadow: 0 2px 12px rgba(184,118,10,0.06);
      transition: transform 0.25s, box-shadow 0.25s;
    }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(184,118,10,0.12); }

    .stat-icon {
      width: 46px; height: 46px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }
    .stat-icon.blue  { background: rgba(42,122,186,0.12); }
    .stat-icon.red   { background: rgba(201,68,68,0.12); }
    .stat-icon.green { background: rgba(46,158,94,0.12); }
    .stat-icon.gold  { background: var(--gold-pale); }

    .stat-info span { display: block; font-family: 'Amiri', serif; font-size: 28px; font-weight: 700; color: var(--text); line-height: 1; }
    .stat-info p    { font-size: 12px; color: var(--muted); margin-top: 3px; font-weight: 600; }

    /* â”€â”€ CONTRACTOR SECTION â”€â”€ */
    .contractor-section { display: none; margin-bottom: 24px; }

    .contractor-box {
      background: var(--surface);
      border: 1.5px solid var(--border2);
      border-radius: 18px; padding: 22px 28px;
      box-shadow: 0 2px 16px rgba(184,118,10,0.08);
      display: flex; align-items: center;
      justify-content: space-between; flex-wrap: wrap; gap: 16px;
    }

    .contractor-label-title {
      font-family: 'Amiri', serif;
      font-size: 17px; font-weight: 700;
      color: var(--gold2); margin-bottom: 4px;
    }
    .contractor-status { font-size: 12px; color: var(--muted); font-weight: 600; }
    .contractor-status.has-record { color: var(--green); }

    .contractor-controls { display: flex; align-items: center; gap: 10px; }

    .contractor-input {
      background: var(--surface2);
      border: 1.5px solid var(--border2);
      border-radius: 11px; padding: 10px 14px;
      color: var(--text); font-family: 'Tajawal', sans-serif;
      font-size: 15px; font-weight: 700; width: 160px;
      outline: none; text-align: center; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .contractor-input:focus {
      border-color: var(--gold-light);
      box-shadow: 0 0 0 3px rgba(232,184,77,0.18);
    }

    .contractor-save-btn {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white; border: none; border-radius: 11px;
      padding: 11px 22px; font-family: 'Tajawal', sans-serif;
      font-size: 14px; font-weight: 800; cursor: pointer;
      box-shadow: 0 4px 14px rgba(46,158,94,0.28); transition: all 0.25s;
    }
    .contractor-save-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46,158,94,0.4); }
    .contractor-save-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* â”€â”€ TOOLBAR â”€â”€ */
    .toolbar {
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 14px; margin-bottom: 18px;
    }
    .toolbar-title {
      font-family: 'Amiri', serif;
      font-size: 19px; font-weight: 700; color: var(--gold2);
    }
    .toolbar-title span { color: var(--gold); }
    .toolbar-filters { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

    .search-box {
      display: flex; align-items: center; gap: 10px;
      background: var(--surface);
      border: 1.5px solid var(--border2);
      border-radius: 11px; padding: 10px 16px;
      min-width: 260px;
      box-shadow: 0 1px 6px rgba(184,118,10,0.06);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-box:focus-within {
      border-color: var(--gold-light);
      box-shadow: 0 0 0 3px rgba(232,184,77,0.15);
    }
    .search-box input {
      background: transparent; border: none; outline: none;
      color: var(--text); font-family: 'Tajawal', sans-serif;
      font-size: 14px; font-weight: 500; width: 100%;
    }
    .search-box input::placeholder { color: var(--muted); }
    .search-icon { color: var(--muted); font-size: 16px; }

    .select-box {
      background: var(--surface);
      border: 1.5px solid var(--border2);
      border-radius: 11px; padding: 10px 14px;
      color: var(--text); font-family: 'Tajawal', sans-serif;
      font-size: 14px; font-weight: 600; min-width: 160px;
      outline: none; cursor: pointer;
      box-shadow: 0 1px 6px rgba(184,118,10,0.06);
      transition: border-color 0.2s;
    }
    .select-box:focus { border-color: var(--gold-light); }
    .select-box option { background: #fffdf7; color: #3a2c14; }

    /* â”€â”€ TABLE WRAP â”€â”€ */
    .table-wrap {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 18px; overflow: hidden;
      box-shadow: 0 2px 16px rgba(184,118,10,0.07);
    }

    table { width: 100%; border-collapse: collapse; }

    thead tr { background: var(--gold-pale); }
    thead th {
      padding: 14px 18px; text-align: right;
      font-size: 12px; font-weight: 800;
      text-transform: uppercase; letter-spacing: 0.7px;
      color: var(--gold2);
      border-bottom: 2px solid rgba(184,118,10,0.18);
    }

    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.2s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    tbody td { padding: 13px 18px; font-size: 14px; color: var(--text); }

    .id-cell {
      font-family: monospace; font-size: 13px; color: var(--blue);
      background: rgba(42,122,186,0.1); padding: 4px 10px;
      border-radius: 7px; display: inline-block; font-weight: 700;
    }
    .shift-cell {
      font-family: monospace; font-size: 13px; color: var(--gold2);
      background: var(--gold-pale); padding: 4px 10px;
      border-radius: 7px; display: inline-block; font-weight: 700;
    }
    .name-cell { font-weight: 700; color: var(--text); }
    .dept-cell {
      font-size: 12px; color: var(--muted); font-weight: 700;
      background: rgba(180,130,60,0.08); padding: 4px 12px;
      border-radius: 20px; display: inline-block;
    }
    .row-num { color: var(--muted); font-size: 13px; font-weight: 600; }

    .state-box { text-align: center; padding: 60px 20px; color: var(--muted); }
    .state-box .icon { font-size: 48px; margin-bottom: 14px; }
    .state-box p { font-size: 15px; margin-bottom: 6px; color: var(--text); font-weight: 700; }
    .state-box small { font-size: 13px; }

    /* Ramadan loading spinner */
    .spinner-wrap {
      display: flex; align-items: center; justify-content: center;
      gap: 16px; padding: 60px 20px; color: var(--muted);
      font-size: 15px; font-weight: 600;
    }
    .ramadan-loader {
      display: flex; gap: 8px;
    }
    .ramadan-loader span {
      font-size: 26px;
      animation: ramadan-pulse 1.4s ease-in-out infinite;
    }
    .ramadan-loader span:nth-child(2) { animation-delay: 0.22s; }
    .ramadan-loader span:nth-child(3) { animation-delay: 0.44s; }
    @keyframes ramadan-pulse {
      0%, 100% { opacity: 0.2; transform: scale(0.8); }
      50%       { opacity: 1;   transform: scale(1.15); }
    }

    .no-results { text-align: center; padding: 40px; color: var(--muted); font-size: 14px; font-weight: 600; display: none; }

    .cb-wrap { display: flex; align-items: center; justify-content: center; }
    input[type="checkbox"] {
      width: 18px; height: 18px;
      accent-color: var(--gold); cursor: pointer;
    }

    tbody tr.selected-row {
      background: rgba(184,118,10,0.07) !important;
      border-right: 3px solid var(--gold);
    }
    tbody tr.already-added { opacity: 0.45; pointer-events: none; }

    .added-badge {
      display: inline-block;
      background: rgba(46,158,94,0.13); color: var(--green);
      border: 1px solid rgba(46,158,94,0.35);
      padding: 2px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 800; margin-left: 8px;
    }

    /* â”€â”€ SELECTED PANEL â”€â”€ */
    .selected-panel { margin-top: 28px; display: none; }
    .selected-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 12px; margin-bottom: 16px;
    }
    .selected-title {
      font-family: 'Amiri', serif;
      font-size: 18px; font-weight: 700; color: var(--gold2);
    }
    .selected-title span { color: var(--gold); }

    .save-btn {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white; border: none; padding: 12px 28px; border-radius: 11px;
      font-family: 'Tajawal', sans-serif; font-size: 14px; font-weight: 800;
      cursor: pointer; transition: all 0.25s;
      box-shadow: 0 4px 15px rgba(46,158,94,0.28);
    }
    .save-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46,158,94,0.4); }
    .save-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .clear-btn {
      background: rgba(201,68,68,0.08);
      border: 1.5px solid rgba(201,68,68,0.3);
      color: var(--rose); padding: 10px 20px; border-radius: 11px;
      font-family: 'Tajawal', sans-serif; font-size: 13px; font-weight: 700;
      cursor: pointer; transition: all 0.25s;
    }
    .clear-btn:hover { background: var(--rose); color: white; }

    /* â”€â”€ TOAST â”€â”€ */
    .toast {
      position: fixed; bottom: 28px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--surface);
      border: 1.5px solid rgba(46,158,94,0.4);
      color: var(--text);
      padding: 13px 26px; border-radius: 14px;
      font-size: 14px; font-weight: 700;
      box-shadow: 0 16px 40px rgba(0,0,0,0.1);
      z-index: 999; transition: transform 0.35s ease; white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.error { border-color: rgba(201,68,68,0.4); }

    /* â”€â”€ SCROLLBAR â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--surface2); }
    ::-webkit-scrollbar-thumb { background: rgba(184,118,10,0.3); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(184,118,10,0.5); }

    @media (max-width: 700px) {
      header { padding: 16px 20px; }
      main   { padding: 20px 16px; }
      .toolbar { flex-direction: column; align-items: flex-start; }
      .toolbar-filters { width: 100%; }
      .search-box { min-width: 0; flex: 1; }
      .select-box { width: 100%; }
      .contractor-box { flex-direction: column; align-items: flex-start; }
      .contractor-controls { width: 100%; }
      .contractor-input { flex: 1; width: auto; }
    }
  </style>
</head>
<body>

<div class="top-band"></div>
<div class="bg-art"></div>
<div class="grain"></div>
<div class="pattern-overlay"></div>

<header>
  <div class="header-left">
    <div class="logo-icon">ğŸ½ï¸</div>
    <div class="header-title">
      <h1>ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h1>
      <p id="headerSub">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>
  <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap;">
    <div class="dept-badge" id="deptBadge">â€”</div>
    <div class="user-info">
      <div class="avatar" id="avatarInitial">â€”</div>
      <div class="user-details">
        <span id="headerName">â€”</span>
        <small id="headerRole">Admin</small>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<main>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-icon blue">ğŸ‘¥</div>
      <div class="stat-info"><span id="statTotal">â€”</span><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon gold">ğŸ·ï¸</div>
      <div class="stat-info"><span id="statDept">â€”</span><p>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green">ğŸ”</div>
      <div class="stat-info"><span id="statFiltered">â€”</span><p>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</p></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon red">âœ…</div>
      <div class="stat-info"><span id="statSelected">0</span><p>Ø§Ù„Ù…Ø®ØªØ§Ø±ÙˆÙ†</p></div>
    </div>
  </div>

  <!-- Contractor Section â€” Administration Only -->
  <div class="contractor-section" id="contractorSection">
    <div class="contractor-box">
      <div>
        <div class="contractor-label-title">ğŸ‘· Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="contractor-status" id="contractorStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
      <div class="contractor-controls">
        <input type="number" id="contractorCount" class="contractor-input" min="0" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯">
        <button class="contractor-save-btn" id="contractorSaveBtn" onclick="saveContractor()">ğŸ’¾ Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-title">Ù…ÙˆØ¸ÙÙˆ Ø¥Ø¯Ø§Ø±Ø© <span id="toolbarDept">...</span></div>
    <div class="toolbar-filters">
      <select id="shiftFilter" class="select-box" onchange="applyFilters()">
        <option value="">ÙƒÙ„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª</option>
        <option value="Dayshift">Dayshift</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
      </select>
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput"
               placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©..."
               oninput="applyFilters()">
      </div>
    </div>
  </div>

  <!-- Employee Table -->
  <div class="table-wrap" id="tableWrap">
    <div class="spinner-wrap" id="loadingState">
      <div class="ramadan-loader">
        <span>ğŸŒ™</span><span>â­</span><span>ğŸ•Œ</span>
      </div>
      <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...</span>
    </div>
    <div class="state-box" id="errorState" style="display:none">
      <div class="icon">âš ï¸</div>
      <p>ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
      <small id="errorMsg"></small>
    </div>
    <table id="empTable" style="display:none">
      <thead>
        <tr>
          <th style="width:50px; text-align:center">
            <div class="cb-wrap">
              <input type="checkbox" id="selectAll" title="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„" onchange="toggleSelectAll(this)">
            </div>
          </th>
          <th style="width:50px">#</th>
          <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
          <th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th>
          <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
          <th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
        </tr>
      </thead>
      <tbody id="empBody"></tbody>
    </table>
    <div class="no-results" id="noResults">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ ğŸ”</div>
  </div>

  <!-- Selected Panel -->
  <div class="selected-panel" id="selectedPanel">
    <div class="selected-panel-header">
      <div class="selected-title">Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ù…Ø®ØªØ§Ø±ÙˆÙ† &nbsp;<span id="selectedCount">0</span></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="clear-btn" onclick="clearSelection()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</button>
        <button class="save-btn" id="saveBtn" onclick="saveOrders()">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Orders</button>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th>
            <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th><th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          </tr>
        </thead>
        <tbody id="selectedBody"></tbody>
      </table>
    </div>
  </div>

</main>

<div class="toast" id="toast"></div>

<script>
  const SCRIPT_URL     = 'https://script.google.com/macros/s/AKfycbxFhhA5mG-jPSexRF0hQk-qJ6vB4JuzPcDxy1UQDHv6MP4asgYGWt2FMahmpWEm2JCPsg/exec';
  const CONTRACTOR_URL = 'https://script.google.com/macros/s/AKfycbw7yJo25YWoIpzO5fw_WlOxzF6qytA8AxqIfgfXC_o6MsGwMLGbORkQa0zQ93rNJsNs6Q/exec';

  let allEmployees       = [];
  let filteredEmps       = [];
  let selectedEmps       = new Map();
  let todayNames         = new Set();
  let contractorRowIndex = null;

  const TODAY_STR = new Date().toISOString().split('T')[0];

  const rawUser = sessionStorage.getItem('currentUser');
  if (!rawUser) window.location.assign('index.html');
  const user = JSON.parse(rawUser);

  if ((user.Role || '').trim().toLowerCase() !== 'admin') {
    alert('â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„');
    window.location.assign('index.html');
  }

  document.getElementById('headerName').textContent    = user.User_Name  || 'â€”';
  document.getElementById('headerRole').textContent    = user.Role       || 'Admin';
  document.getElementById('deptBadge').textContent     = user.Department || 'â€”';
  document.getElementById('toolbarDept').textContent   = user.Department || 'â€”';
  document.getElementById('statDept').textContent      = user.Department || 'â€”';
  document.getElementById('headerSub').textContent     = `Ø¥Ø¯Ø§Ø±Ø© ${user.Department || ''}`;
  document.getElementById('avatarInitial').textContent = (user.User_Name || 'A').charAt(0).toUpperCase();

  if ((user.Department || '').trim() === 'Administration') {
    document.getElementById('contractorSection').style.display = 'block';
  }

  // â”€â”€ Contractor: ØªØ­Ù…ÙŠÙ„ â”€â”€
  async function loadContractor() {
    const statusEl = document.getElementById('contractorStatus');
    statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    statusEl.className   = 'contractor-status';
    try {
      const res = await fetch(CONTRACTOR_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action: 'get_contractor', date: TODAY_STR })
      });
      const result = await res.json();
      if (result.ok && result.quantity !== null) {
        document.getElementById('contractorCount').value = result.quantity;
        contractorRowIndex   = result.rowIndex;
        statusEl.textContent = `âœ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${result.quantity} Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù`;
        statusEl.className   = 'contractor-status has-record';
      } else {
        contractorRowIndex   = null;
        statusEl.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯';
        statusEl.className   = 'contractor-status';
      }
    } catch(err) {
      statusEl.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }
  }

  // â”€â”€ Contractor: Ø­ÙØ¸ / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù â”€â”€
  async function saveContractor() {
    const val      = document.getElementById('contractorCount').value.trim();
    const btn      = document.getElementById('contractorSaveBtn');
    const statusEl = document.getElementById('contractorStatus');
    btn.disabled    = true;
    btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    try {
      let result;
      if (val === '' && contractorRowIndex) {
        const res = await fetch(CONTRACTOR_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ action: 'delete_contractor', rowIndex: contractorRowIndex })
        });
        result = await res.json();
        if (result.ok) {
          contractorRowIndex   = null;
          statusEl.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯';
          statusEl.className   = 'contractor-status';
          showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„');
        }
      } else if (contractorRowIndex) {
        if (!val || isNaN(val) || Number(val) < 0) { showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹', true); return; }
        const res = await fetch(CONTRACTOR_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ action: 'update_contractor', rowIndex: contractorRowIndex, quantity: val })
        });
        result = await res.json();
        if (result.ok) {
          statusEl.textContent = `âœ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${val} Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù`;
          statusEl.className   = 'contractor-status has-record';
          showToast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†');
        }
      } else {
        if (!val || isNaN(val) || Number(val) < 0) { showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹', true); return; }
        const res = await fetch(CONTRACTOR_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ action: 'save_contractor', date: TODAY_STR, submitted_by: user.User_Name, quantity: val })
        });
        result = await res.json();
        if (result.ok) { await loadContractor(); showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†'); }
      }
      if (result && !result.ok) showToast('âŒ ' + (result.message || result.error), true);
    } catch(err) {
      showToast('âŒ Ø®Ø·Ø£: ' + err.message, true);
    }
    btn.disabled    = false;
    btn.textContent = 'ğŸ’¾ Ø­ÙØ¸';
  }

  // â”€â”€ Employees â”€â”€
  async function loadEmployees() {
    try {
      todayNames.clear();
      const [empRes, todayRes] = await Promise.all([
        fetch(SCRIPT_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ action: 'get_employees', department: user.Department, today: TODAY_STR })
        }),
        fetch(SCRIPT_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ action: 'get_today_orders', today: TODAY_STR, department: user.Department })
        })
      ]);
      const empResult   = await empRes.json();
      const todayResult = await todayRes.json();
      document.getElementById('loadingState').style.display = 'none';
      if (!empResult.ok) {
        document.getElementById('errorMsg').textContent = empResult.message || empResult.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        document.getElementById('errorState').style.display = 'block';
        return;
      }
      if (todayResult.ok && todayResult.names) {
        todayResult.names.forEach(n => todayNames.add(n.trim().toLowerCase()));
      }
      allEmployees = (empResult.employees || []).map(e => ({
        id:    String(e.id    ?? '').trim(),
        name:  String(e.name  ?? '').trim(),
        dept:  String(e.dept  ?? '').trim(),
        shift: String((e.shift ?? e.shift_code ?? e.Shift_Code ?? '')).trim()
      }));
      document.getElementById('statTotal').textContent = allEmployees.length;
      applyFilters();
      document.getElementById('empTable').style.display = 'table';
    } catch(err) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorMsg').textContent = err.message;
      document.getElementById('errorState').style.display = 'block';
    }
  }

  function renderTable(employees) {
    const tbody = document.getElementById('empBody');
    tbody.innerHTML = '';
    if (employees.length === 0) {
      document.getElementById('noResults').style.display = 'block';
      document.getElementById('statFiltered').textContent = 0;
      syncSelectAll(); return;
    }
    document.getElementById('noResults').style.display = 'none';
    employees.forEach((emp, i) => {
      const isChecked = selectedEmps.has(emp.id);
      const isAdded   = todayNames.has((emp.name || '').trim().toLowerCase());
      const tr        = document.createElement('tr');
      if (isChecked) tr.classList.add('selected-row');
      if (isAdded)   tr.classList.add('already-added');
      const safeName = (emp.name || '').replace(/'/g, "\\'");
      tr.innerHTML = `
        <td><div class="cb-wrap">
          <input type="checkbox" data-id="${emp.id}"
            ${isChecked ? 'checked' : ''} ${isAdded ? 'disabled' : ''}
            onchange="toggleEmployee(this,'${emp.id}','${safeName}','${emp.dept}','${emp.shift || ''}')">
        </div></td>
        <td class="row-num">${i + 1}</td>
        <td><span class="id-cell">${emp.id}</span></td>
        <td><span class="shift-cell">${emp.shift || ''}</span></td>
        <td class="name-cell">
          ${isAdded ? '<span class="added-badge">âœ“ Ù…Ø¶Ø§Ù</span>' : ''}${emp.name}
        </td>
        <td><span class="dept-cell">${emp.dept}</span></td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('statFiltered').textContent = employees.length;
    syncSelectAll();
  }

  function toggleEmployee(cb, id, name, dept, shift) {
    const tr = cb.closest('tr');
    if (cb.checked) {
      selectedEmps.set(id, { id, name, dept, shift });
      tr.classList.add('selected-row');
    } else {
      selectedEmps.delete(id);
      tr.classList.remove('selected-row');
    }
    updateSelectedPanel(); syncSelectAll();
  }

  function toggleSelectAll(cb) {
    document.querySelectorAll('#empBody tr:not(.already-added)').forEach(tr => {
      const rowCb = tr.querySelector('input[type="checkbox"]');
      const id    = rowCb.dataset.id;
      const name  = tr.querySelector('.name-cell').innerText.trim().replace(/^âœ“ Ù…Ø¶Ø§Ù\s*/, '');
      const dept  = tr.querySelector('.dept-cell').innerText.trim();
      const shift = tr.querySelector('.shift-cell').innerText.trim();
      if (cb.checked) {
        rowCb.checked = true;
        selectedEmps.set(id, { id, name, dept, shift });
        tr.classList.add('selected-row');
      } else {
        rowCb.checked = false;
        selectedEmps.delete(id);
        tr.classList.remove('selected-row');
      }
    });
    updateSelectedPanel();
  }

  function syncSelectAll() {
    const visibleIds  = [...document.querySelectorAll('#empBody tr:not(.already-added) input[type="checkbox"]')].map(cb => cb.dataset.id);
    const allChecked  = visibleIds.length > 0 && visibleIds.every(id => selectedEmps.has(id));
    const someChecked = visibleIds.some(id => selectedEmps.has(id));
    const cb = document.getElementById('selectAll');
    if (cb) { cb.checked = allChecked; cb.indeterminate = !allChecked && someChecked; }
  }

  function updateSelectedPanel() {
    const count = selectedEmps.size;
    document.getElementById('statSelected').textContent  = count;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('selectedPanel').style.display = count > 0 ? 'block' : 'none';
    const tbody = document.getElementById('selectedBody');
    tbody.innerHTML = '';
    let i = 1;
    selectedEmps.forEach(emp => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="row-num">${i++}</td>
        <td><span class="id-cell">${emp.id}</span></td>
        <td><span class="shift-cell">${emp.shift || ''}</span></td>
        <td class="name-cell">${emp.name}</td>
        <td><span class="dept-cell">${emp.dept}</span></td>
        <td>${TODAY_STR}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function clearSelection() {
    selectedEmps.clear();
    document.querySelectorAll('#empBody input[type="checkbox"]').forEach(cb => {
      cb.checked = false;
      cb.closest('tr').classList.remove('selected-row');
    });
    updateSelectedPanel(); syncSelectAll();
  }

  async function saveOrders() {
    if (selectedEmps.size === 0) return;
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled  = true;
    saveBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    const rows = [];
    selectedEmps.forEach(emp => {
      const empName = (emp.name || '').trim();
      if (!empName) return;
      rows.push({ date: TODAY_STR, submitted_by: user.User_Name, employee: empName, department: emp.dept });
    });
    if (rows.length === 0) {
      showToast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø© Ù„Ù„Ø­ÙØ¸', true);
      saveBtn.disabled  = false;
      saveBtn.innerHTML = 'ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Orders';
      return;
    }
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action: 'save_orders', rows: JSON.stringify(rows) })
      });
      const result = await res.json();
      if (result.ok) {
        showToast(`âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ (${rows.length})`);
        clearSelection();
        await loadEmployees();
      } else {
        showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (result.message || result.error), true);
      }
    } catch(err) {
      showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message, true);
    }
    saveBtn.disabled  = false;
    saveBtn.innerHTML = 'ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Orders';
  }

  function applyFilters() {
    const q          = (document.getElementById('searchInput').value || '').trim().toLowerCase();
    const shiftValue = document.getElementById('shiftFilter').value;
    filteredEmps = allEmployees.filter(e => {
      const nameMatch        = (e.name  || '').toLowerCase().includes(q);
      const idMatch          = (e.id    || '').toLowerCase().includes(q);
      const shiftTextMatch   = (e.shift || '').toLowerCase().includes(q);
      const shiftFilterMatch = !shiftValue || (e.shift === shiftValue);
      return (nameMatch || idMatch || shiftTextMatch) && shiftFilterMatch;
    });
    renderTable(filteredEmps);
  }

  function showToast(msg, isError = false) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className   = 'toast' + (isError ? ' error' : '');
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3500);
  }

  function logout() {
    sessionStorage.clear();
    window.location.assign('index.html');
  }

  loadEmployees();
  if ((user.Department || '').trim() === 'Administration') loadContractor();
</script>

</body>
</html>
